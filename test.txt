-- -----------------------------------------------------------------------------
-- Script name:   AVSA_VAR_Logged.hql
-- Created on:    13/11/2015
-- Authors:       Melchiorre, Pierpaolo
-- Purpose:       Process to calculate the VAR Logged KPIs
-- -----------------------------------------------------------------------------

-- creating table to store the VAR Logged's KPIs
CREATE EXTERNAL TABLE IF NOT EXISTS var_logged (
  date STRING,
  user_id STRING,
  birth_date DATE,
  gender STRING,
  age_bracket STRING,
  country STRING,
  state STRING,
  province STRING,
  city STRING,
  zip_code STRING,
  registration_method STRING,
  referral_source STRING,
  registration_trigger STRING,
  registration_date STRING,
  most_used_platform STRING,
  first_access_date STRING,
  first_view_date STRING,
  accesses_1d INT,
  number_used_platforms_1d INT,
  number_used_devices_1d INT,
  video_views_1d INT,
  video_playback_duration_1d INT,
  live_views_1d INT,
  live_playback_duration_1d INT,
  views_1d INT,
  playback_duration_1d INT,
  top_watched_category_1d STRING,
  top_watched_channel_1d STRING,
  downloads_1d INT,
  playlists_1d INT,
  impressions_1d INT,
  viewed_adv_1d INT,
  clicks_through_1d INT,
  skipped_adv_1d INT,
  likes_1d INT,
  dislikes_1d INT,
  ratings_1d INT,
  searches_1d INT,
  reminders_1d INT,
  video_drop_off_1d INT,
  average_video_drop_off_1d DOUBLE,
  launched_apps_1d INT,
  purchases_1d INT,
  revenues_1d DOUBLE,
  npvr_requests_1d INT,
  npvr_views_1d INT,
  accesses_7D INT,
  number_used_platforms_7D INT,
  number_used_devices_7D INT,
  video_views_7D INT,
  video_playback_duration_7D INT,
  live_views_7D INT,
  live_playback_duration_7D INT,
  views_7D INT,
  playback_duration_7D INT,
  top_watched_category_7D STRING,
  top_watched_channel_7D STRING,
  downloads_7D INT,
  playlists_7D INT,
  impressions_7D INT,
  viewed_adv_7D INT,
  clicks_through_7D INT,
  skipped_adv_7D INT,
  likes_7D INT,
  dislikes_7D INT,
  ratings_7D INT,
  searches_7D INT,
  reminders_7D INT,
  video_drop_off_7D INT,
  average_video_drop_off_7D DOUBLE,
  launched_apps_7D INT,
  purchases_7D INT,
  revenues_7D DOUBLE,
  npvr_requests_7D INT,
  npvr_views_7D INT,
  accesses_30D INT,
  number_used_platforms_30D INT,
  number_used_devices_30D INT,
  video_views_30D INT,
  video_playback_duration_30D INT,
  live_views_30D INT,
  live_playback_duration_30D INT,
  views_30D INT,
  playback_duration_30D INT,
  top_watched_category_30D STRING,
  top_watched_channel_30D STRING,
  downloads_30D INT,
  playlists_30D INT,
  impressions_30D INT,
  viewed_adv_30D INT,
  clicks_through_30D INT,
  skipped_adv_30D INT,
  likes_30D INT,
  dislikes_30D INT,
  ratings_30D INT,
  searches_30D INT,
  reminders_30D INT,
  video_drop_off_30D INT,
  average_video_drop_off_30D DOUBLE,
  launched_apps_30D INT,
  purchases_30D INT,
  revenues_30D DOUBLE,
  npvr_requests_30D INT,
  npvr_views_30D INT,
  accesses_60D INT,
  number_used_platforms_60D INT,
  number_used_devices_60D INT,
  video_views_60D INT,
  video_playback_duration_60D INT,
  live_views_60D INT,
  live_playback_duration_60D INT,
  views_60D INT,
  playback_duration_60D INT,
  top_watched_category_60D STRING,
  top_watched_channel_60D STRING,
  downloads_60D INT,
  playlists_60D INT,
  impressions_60D INT,
  viewed_adv_60D INT,
  clicks_through_60D INT,
  skipped_adv_60D INT,
  likes_60D INT,
  dislikes_60D INT,
  ratings_60D INT,
  searches_60D INT,
  reminders_60D INT,
  video_drop_off_60D INT,
  average_video_drop_off_60D DOUBLE,
  launched_apps_60D INT,
  purchases_60D INT,
  revenues_60D DOUBLE,
  npvr_requests_60D INT,
  npvr_views_60D INT,
  accesses_90D INT,
  number_used_platforms_90D INT,
  number_used_devices_90D INT,
  video_views_90D INT,
  video_playback_duration_90D INT,
  live_views_90D INT,
  live_playback_duration_90D INT,
  views_90D INT,
  playback_duration_90D INT,
  top_watched_category_90D STRING,
  top_watched_channel_90D STRING,
  downloads_90D INT,
  playlists_90D INT,
  impressions_90D INT,
  viewed_adv_90D INT,
  clicks_through_90D INT,
  skipped_adv_90D INT,
  likes_90D INT,
  dislikes_90D INT,
  ratings_90D INT,
  searches_90D INT,
  reminders_90D INT,
  video_drop_off_90D INT,
  average_video_drop_off_90D DOUBLE,
  launched_apps_90D INT,
  purchases_90D INT,
  revenues_90D DOUBLE,
  npvr_requests_90D INT,
  npvr_views_90D INT
)
ROW FORMAT
DELIMITED FIELDS TERMINATED BY '\073'
LINES TERMINATED BY '\n'
STORED AS TEXTFILE
LOCATION '${hivevar:root_path}/agg/VAR_LOGGED/output';

-- inserting data into var_logged table
INSERT OVERWRITE TABLE var_logged
SELECT
  t1.*, 
  t2.accesses_7D,
  t2.number_used_platforms_7D,
  t2.number_used_devices_7D,
  t2.video_views_7D,
  t2.video_playback_duration_7D,
  t2.live_views_7D,
  t2.live_playback_duration_7D,
  t2.views_7D,
  t2.playback_duration_7D,
  t2.top_watched_category_7D,
  t2.top_watched_channel_7D,
  t2.downloads_7D,
  t2.playlists_7D,
  t2.impressions_7D,
  t2.viewed_adv_7D,
  t2.clicks_through_7D,
  t2.skipped_adv_7D,
  t2.likes_7D,
  t2.dislikes_7D,
  t2.ratings_7D,
  t2.searches_7D,
  t2.reminders_7D,
  t2.video_drop_off_7D,
  t2.average_video_drop_off_7D,
  t2.launched_apps_7D,
  t2.purchases_7D,
  t2.revenues_7D,
  t2.npvr_requests_7D,
  t2.npvr_views_7D,
  t3.accesses_30D,
  t3.number_used_platforms_30D,
  t3.number_used_devices_30D,
  t3.video_views_30D,
  t3.video_playback_duration_30D,
  t3.live_views_30D,
  t3.live_playback_duration_30D,
  t3.views_30D,
  t3.playback_duration_30D,
  t3.top_watched_category_30D,
  t3.top_watched_channel_30D,
  t3.downloads_30D,
  t3.playlists_30D,
  t3.impressions_30D,
  t3.viewed_adv_30D,
  t3.clicks_through_30D,
  t3.skipped_adv_30D,
  t3.likes_30D,
  t3.dislikes_30D,
  t3.ratings_30D,
  t3.searches_30D,
  t3.reminders_30D,
  t3.video_drop_off_30D,
  t3.average_video_drop_off_30D,
  t3.launched_apps_30D,
  t3.purchases_30D,
  t3.revenues_30D,
  t3.npvr_requests_30D,
  t3.npvr_views_30D,
  t4.accesses_60D,
  t4.number_used_platforms_60D,
  t4.number_used_devices_60D,
  t4.video_views_60D,
  t4.video_playback_duration_60D,
  t4.live_views_60D,
  t4.live_playback_duration_60D,
  t4.views_60D,
  t4.playback_duration_60D,
  t4.top_watched_category_60D,
  t4.top_watched_channel_60D,
  t4.downloads_60D,
  t4.playlists_60D,
  t4.impressions_60D,
  t4.viewed_adv_60D,
  t4.clicks_through_60D,
  t4.skipped_adv_60D,
  t4.likes_60D,
  t4.dislikes_60D,
  t4.ratings_60D,
  t4.searches_60D,
  t4.reminders_60D,
  t4.video_drop_off_60D,
  t4.average_video_drop_off_60D,
  t4.launched_apps_60D,
  t4.purchases_60D,
  t4.revenues_60D,
  t4.npvr_requests_60D,
  t4.npvr_views_60D,
  t5.accesses_90D,
  t5.number_used_platforms_90D,
  t5.number_used_devices_90D,
  t5.video_views_90D,
  t5.video_playback_duration_90D,
  t5.live_views_90D,
  t5.live_playback_duration_90D,
  t5.views_90D,
  t5.playback_duration_90D,
  t5.top_watched_category_90D,
  t5.top_watched_channel_90D,
  t5.downloads_90D,
  t5.playlists_90D,
  t5.impressions_90D,
  t5.viewed_adv_90D,
  t5.clicks_through_90D,
  t5.skipped_adv_90D,
  t5.likes_90D,
  t5.dislikes_90D,
  t5.ratings_90D,
  t5.searches_90D,
  t5.reminders_90D,
  t5.video_drop_off_90D,
  t5.average_video_drop_off_90D,
  t5.launched_apps_90D,
  t5.purchases_90D,
  t5.revenues_90D,
  t5.npvr_requests_90D,
  t5.npvr_views_90D
FROM var_logged_1D t1 
JOIN var_logged_7D t2 ON t1.user_id = t2.user_id
JOIN var_logged_30D t3 ON t1.user_id = t3.user_id
JOIN var_logged_60D t4 ON t1.user_id = t4.user_id
JOIN var_logged_90D t5 ON t1.user_id = t5.user_id;
